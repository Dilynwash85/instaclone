
# --- Start of tests ---

unset INSTACLONE_DIR

# Platform and Python version we're using to run tests.
uname
Darwin

python -V
Python 2.7.10

run purge
purging cache: __DIR/.instaclone/cache

# Error invocations.
run bad_command || expect_error
usage: main.py [-h] [-v] [--config CONFIG] [-f] [--debug]
               {publish,install,purge,configs}
main.py: error: argument command: invalid choice: 'bad_command' (choose from 'publish', 'install', 'purge', 'configs')
(got expected error: status 2)

run configs
using config file: ./instaclone.yml
items:
- copy_type: symlink
  download_command: s4cmd get $REMOTE $LOCAL
  local_path: test-file1
  remote_path: another-folder
  remote_prefix: s3://__BUCKET/tmp/instaclone-tests
  upload_command: s4cmd put -f $LOCAL $REMOTE
  version: v11
- copy_type: hardlink
  download_command: s4cmd get $REMOTE $LOCAL
  local_path: test-file2
  remote_path: another-folder
  remote_prefix: s3://__BUCKET/tmp/instaclone-tests
  upload_command: s4cmd put -f $LOCAL $REMOTE
  version: v22
- copy_type: symlink
  download_command: s4cmd get $REMOTE $LOCAL
  local_path: test-dir
  remote_path: some/remote/folder
  remote_prefix: s3://__BUCKET/instaclone/tmp-tests
  upload_command: s4cmd put -f $LOCAL $REMOTE
  version_command: echo testver
  version_hashable: test-file2-hashable

# Check contents before.
ls_portable
-rw-r--r-- instaclone.yml
drwxr-xr-x test-dir/
-rw-r--r-- test-file1
-rw-r--r-- test-file2
-rw-r--r-- test-file2-hashable

ls_portable test-dir/
-rw-r--r-- file-a
-rw-r--r-- file-b

head -10 test-dir/* test-file{1,2}
==> test-dir/file-a <==
contents a

==> test-dir/file-b <==
contents b

==> test-file1 <==
some
contents

==> test-file2 <==
some
more
contents

run install || expect_error
using config file: ./instaclone.yml
cache dir not found, so creating: __DIR/.instaclone/cache
initializing new cache: __DIR/.instaclone/cache
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip.partial.__X
[Runtime Failure] Source doesn't exist.
installing file: test-file1 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 <- s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X
[Runtime Failure] Source doesn't exist.
error: Command '['s4cmd', 'get', 's3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1', '__DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X']' returned non-zero exit status 1
(run with --debug for traceback info)
(got expected error: status 2)

run publish
using config file: ./instaclone.yml
using cache: __DIR/.instaclone/cache
installing to cache: test-file1 -> __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
uploading: s4cmd put -f __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
__DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 => s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
published file: test-file1 -> s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
installing to cache: test-file2 -> __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
uploading: s4cmd put -f __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
__DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 => s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
published file: test-file2 -> s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
installing to cache: test-dir -> __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir
compress: zip -q -r __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip.partial.__X .
uploading: s4cmd put -f __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip
__DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip => s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip
decompress: ditto -x -k __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip .
published directory archive: test-dir -> s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip

# Check for results of publish.
ls_portable
-rw-r--r-- instaclone.yml
lrwxr-xr-x __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir
drwxr-xr-x test-dir.bak/
lrwxr-xr-x __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
-r--r--r-- test-file2
-rw-r--r-- test-file2-hashable

ls_portable test-dir/
-r--r--r-- file-a
-r--r--r-- file-b

head -10 test-dir/* test-file{1,2}
==> test-dir/file-a <==
contents a

==> test-dir/file-b <==
contents b

==> test-file1 <==
some
contents

==> test-file2 <==
some
more
contents

# Publish again.
run publish || expect_error
using config file: ./instaclone.yml
error: cannot publish symlinks (is path already published?): test-file1
(run with --debug for traceback info)
(got expected error: status 2)

run install -f
using config file: ./instaclone.yml
using cache: __DIR/.instaclone/cache
installing from cache: test-file1 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
installing from cache: test-file2 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
installing from cache: test-dir <- __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir

# Try cleaning cache again and re-installing.

run purge
purging cache: __DIR/.instaclone/cache

# This should fail since we installed before.
run install || expect_error
using config file: ./instaclone.yml
cache dir not found, so creating: __DIR/.instaclone/cache
initializing new cache: __DIR/.instaclone/cache
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip.partial.__X
[Runtime Failure] Source doesn't exist.
installing file: test-file1 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 <- s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X
s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 => __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.zip __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.zip.partial.__X
[Runtime Failure] Source doesn't exist.
installing file: test-file2 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 <- s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.partial.__X
s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 => __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.partial.__X
error: target already exists: test-file2
(run with --debug for traceback info)
(got expected error: status 2)

run install -f
using config file: ./instaclone.yml
using cache: __DIR/.instaclone/cache
installing from cache: test-file1 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
installing from cache: test-file2 <- __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
downloading: s4cmd get s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip.partial.__X
s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip => __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip.partial.__X
installing directory: test-dir <- __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir <- s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip
decompress: ditto -x -k __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip .

# Check contents once more.
ls_portable
-rw-r--r-- instaclone.yml
lrwxr-xr-x __DIR/.instaclone/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir
drwxr-xr-x test-dir.bak/
lrwxr-xr-x __DIR/.instaclone/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
-r--r--r-- test-file2
-rw-r--r-- test-file2-hashable

ls_portable test-dir/
-r--r--r-- file-a
-r--r--r-- file-b

# Try non-default instaclone cache directory.
export INSTACLONE_DIR=/tmp/instaclone-dir
chmod -R +w $INSTACLONE_DIR || true
rm -rf $INSTACLONE_DIR

run install -f
using config file: ./instaclone.yml
cache dir not found, so creating: /tmp/instaclone-dir/cache
initializing new cache: /tmp/instaclone-dir/cache
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.zip.partial.__X
[Runtime Failure] Source doesn't exist.
installing file: test-file1 <- /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 <- s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X
s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1 => /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file1.$v11$/test-file1.partial.__X
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.zip /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.zip.partial.__X
[Runtime Failure] Source doesn't exist.
installing file: test-file2 <- /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 <- s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2
downloading: s4cmd get s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.partial.__X
s3://__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2 => /tmp/instaclone-dir/cache/contents/s3/__BUCKET/tmp/instaclone-tests/another-folder/test-file2.$v22$/test-file2.partial.__X
downloading: s4cmd get s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip /tmp/instaclone-dir/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip.partial.__X
s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip => /tmp/instaclone-dir/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip.partial.__X
installing directory: test-dir <- /tmp/instaclone-dir/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir <- s3://__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip
decompress: ditto -x -k /tmp/instaclone-dir/cache/contents/s3/__BUCKET/instaclone/tmp-tests/some/remote/folder/test-dir.$7d16c1801be9ca0c00901c354638d9138bf7e353-testver$/test-dir.zip .

# Leave files installed in case it's helpful to debug anything.

# --- End of tests ---
